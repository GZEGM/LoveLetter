<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G·ª≠i Ng∆∞·ªùi Th∆∞∆°ng - Admin</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Nunito:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      // Import Realtime Database
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        child,
        update,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

      // --- C·∫•u h√¨nh Firebase ---
      const firebaseConfig = {
        apiKey: "AIzaSyBvMIS8IRDqyYOhMeIx5qXgHmt1ivXftzU",
        authDomain: "loveletter-f0f23.firebaseapp.com",
        databaseURL: "https://loveletter-f0f23-default-rtdb.firebaseio.com",
        projectId: "loveletter-f0f23",
        storageBucket: "loveletter-f0f23.firebasestorage.app",
        messagingSenderId: "688584515488",
        appId: "1:688584515488:web:e94a5646343464be134ec5",
        measurementId: "G-1JF9CC55P5",
      };
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";

      let currentUser = null;
      let isAuthReady = false;
      let isDomReady = false;
      let db, auth;

      try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
        console.log("Firebase initialized successfully.");
      } catch (error) {
        console.error("Error initializing Firebase:", error);
      }

      // --- H√†m L∆∞u & T·∫£i D·ªØ Li·ªáu (S·ª≠ d·ª•ng RTDB) ---

      // 1. L∆∞u th∆∞ M·ªöI l√™n Realtime Database
      window.saveLetterToFirebase = async (data) => {
        if (!currentUser) {
          window.showCustomAlert(
            "ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß, vui l√≤ng th·ª≠ l·∫°i sau gi√¢y l√°t..."
          );
          return null;
        }
        try {
          // Path: artifacts/{appId}/public/data/letters
          const lettersRef = ref(db, `artifacts/${appId}/public/data/letters`);

          const newLetterRef = push(lettersRef);

          await set(newLetterRef, {
            ...data,
            createdAt: new Date().toISOString(),
            uid: currentUser.uid,
          });

          return newLetterRef.key; // Tr·∫£ v·ªÅ ID c·ªßa th∆∞
        } catch (e) {
          console.error("L·ªói l∆∞u d·ªØ li·ªáu RTDB:", e);
          window.showCustomAlert("Kh√¥ng th·ªÉ l∆∞u th∆∞. Vui l√≤ng th·ª≠ l·∫°i.");
          return null;
        }
      };

      // 2. C·∫¨P NH·∫¨T th∆∞ ƒë√£ c√≥ tr√™n Realtime Database
      window.updateLetterToFirebase = async (id, data) => {
        if (!currentUser) return false;
        try {
          const letterRef = ref(
            db,
            `artifacts/${appId}/public/data/letters/${id}`
          );

          // Gi·ªØ l·∫°i createdAt c≈© n·∫øu c·∫ßn, ho·∫∑c ch·ªâ update c√°c tr∆∞·ªùng n·ªôi dung
          // ·ªû ƒë√¢y ta update n·ªôi dung v√† th√™m updatedAt
          await update(letterRef, {
            ...data,
            updatedAt: new Date().toISOString(),
            // uid: currentUser.uid // C√≥ th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi s·ª≠a n·∫øu c·∫ßn
          });
          return true;
        } catch (e) {
          console.error("L·ªói c·∫≠p nh·∫≠t d·ªØ li·ªáu RTDB:", e);
          window.showCustomAlert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th∆∞. Vui l√≤ng th·ª≠ l·∫°i.");
          return false;
        }
      };

      // 3. T·∫£i th∆∞ t·ª´ Realtime Database
      window.loadLetterFromFirebase = async (id) => {
        if (!db) return null;
        try {
          const dbRef = ref(db);
          // L·∫•y d·ªØ li·ªáu t·ª´ path c·ª• th·ªÉ
          const snapshot = await get(
            child(dbRef, `artifacts/${appId}/public/data/letters/${id}`)
          );

          if (snapshot.exists()) {
            return snapshot.val();
          } else {
            return null;
          }
        } catch (e) {
          console.error("L·ªói t·∫£i d·ªØ li·ªáu RTDB:", e);
          return null;
        }
      };

      // 4. H√†m ki·ªÉm tra URL V√Ä t·∫£i d·ªØ li·ªáu (ch·ªâ ch·∫°y khi DOM v√† Auth s·∫µn s√†ng)
      async function checkUrlAndLoad() {
        if (!isAuthReady || !isDomReady) return;

        const urlParams = new URLSearchParams(window.location.search);
        const letterId = urlParams.get("id");

        if (letterId) {
          const loadingOverlay = document.getElementById("loading-overlay");
          if (loadingOverlay) {
            loadingOverlay.classList.remove("hidden");
          }

          const data = await window.loadLetterFromFirebase(letterId);

          if (loadingOverlay) {
            loadingOverlay.classList.add("hidden");
          }

          if (data) {
            window.applyDataToUI(data);
            document.body.classList.add("view-mode");
            window.showCustomAlert(
              "ƒêang ·ªü ch·∫ø ƒë·ªô xem tr∆∞·ªõc th∆∞ ID: " + letterId
            );
          } else {
            // Kh√¥ng l√†m g√¨ n·∫øu kh√¥ng t√¨m th·∫•y trong ch·∫ø ƒë·ªô admin ƒë·ªÉ tr√°nh phi·ªÅn
          }
        }
      }

      // ƒêƒÉng nh·∫≠p ·∫©n danh ƒë·ªÉ c√≥ quy·ªÅn ghi DB
      const initAuth = async () => {
        if (!auth) return;
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (e) {
          console.error("Auth failed, continuing anonymously:", e);
        }
      };
      initAuth();

      // Theo d√µi tr·∫°ng th√°i x√°c th·ª±c
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
        }
        isAuthReady = true;
        checkUrlAndLoad();
      });

      // Theo d√µi tr·∫°ng th√°i DOM load
      document.addEventListener("DOMContentLoaded", () => {
        isDomReady = true;
        checkUrlAndLoad();
      });
    </script>

    <style>
      /* --- C·∫§U H√åNH CSS ƒê√É CH·ªàNH S·ª¨A V√Ä ƒê·ªíNG B·ªò 100% V·ªöI letter.html --- */
      :root {
        --color-primary: #f06292; /* H·ªìng ƒë·∫≠m */
        --color-secondary: #ffcdd2; /* H·ªìng nh·∫°t */
        --color-bg: #fce4ec; /* Background si√™u nh·∫°t */
      }
      * {
        box-sizing: border-box;
      }
      body {
        /* Cho ph√©p cu·ªôn t·ª± do */
        min-height: 100vh;
        width: 100%;
        background-color: var(--color-bg);
        background-image: linear-gradient(135deg, #fce4ec 0%, #f7a2b9 100%);
        font-family: "Nunito", sans-serif;
        position: relative;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 50px;
      }

      /* --- Layout qu·∫£n l√Ω hi·ªÉn th·ªã --- */

      /* M·∫∑c ƒë·ªãnh: ·∫®n Envelope Container khi ƒëang ·ªü Generator mode (tr·ª´ khi b·∫≠t preview) */
      #envelope-container {
        display: none;
        width: 100%;
        display: flex;
        justify-content: center;
        perspective: 1000px; /* G√≥c nh√¨n 3D */
        z-index: 50;
      }

      /* Khi ·ªü View Mode (xem link): Lu√¥n hi·ªán Envelope, ·∫®n Generator */
      body.view-mode #envelope-container {
        display: flex !important;
        /* CƒÉn gi·ªØa d·ªçc m√†n h√¨nh */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        height: 100vh;
        width: 100vw;
        background: transparent;
        margin-top: 0;
      }
      body.view-mode #generator-ui {
        display: none !important;
      }

      /* Khi b·∫≠t Preview trong Generator: Hi·ªán Envelope */
      body.show-preview #envelope-container {
        display: flex !important;
        margin-top: 50px; /* V·ªã tr√≠ m·∫∑c ƒë·ªãnh tr√™n ƒë·∫ßu */
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Kh·ªëi Phong Th∆∞ (Envelope) (Gi·ªØ nguy√™n) --- */
      .envelope-wrapper {
        position: relative;
        cursor: pointer;
        transition: transform 0.3s;
      }
      .envelope-wrapper:hover {
        transform: scale(1.02);
      }
      .envelope {
        position: relative;
        width: 300px;
        height: 200px;
        background: var(--color-secondary);
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        z-index: 20;
      }
      .envelope::after {
        /* ƒê√°y th∆∞: ph·∫ßn d∆∞·ªõi */
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 150px solid transparent;
        border-right: 150px solid transparent;
        border-bottom: 100px solid var(--color-primary);
        border-radius: 0 0 8px 8px;
        z-index: 20;
        pointer-events: none;
      }
      .envelope::before {
        /* Mi·ªáng th∆∞: che ph·∫ßn tr√™n c√πng */
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 300px;
        height: 200px;
        background: var(--color-secondary);
        z-index: 20;
        pointer-events: none;
        border-radius: 8px;
      }
      .letter-preview {
        /* L√Å TH∆Ø NH·ªé NH√î RA (V·ªä TR√ç ƒê√É FIX) */
        position: absolute;
        width: 270px;
        height: 140px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        top: 90px; /* V·ªã tr√≠ m·∫∑c ƒë·ªãnh */
        left: 15px;
        transition: transform 0.8s ease-in-out, z-index 0.1s;
      }
      .letter-preview .heart-seal {
        font-size: 30px;
        color: var(--color-secondary);
      }
      .flap {
        /* N·∫Øp th∆∞ */
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 150px solid transparent;
        border-right: 150px solid transparent;
        border-top: 120px solid var(--color-primary);
        transform-origin: top;
        transition: transform 0.6s 0.4s ease-in-out;
        z-index: 30;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .seal {
        /* Con d·∫•u */
        position: absolute;
        top: 110px;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        background: #d32f2f;
        border-radius: 50%;
        z-index: 40;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 10px;
        cursor: pointer;
        transition: opacity 0.4s 0.2s;
      }

      /* Animation M·ªü th∆∞ */
      .envelope-wrapper.open .flap {
        transform: rotateX(180deg);
        z-index: 1; /* ƒê·∫©y n·∫Øp ra sau */
      }
      .envelope-wrapper.open .seal {
        opacity: 0;
        pointer-events: none;
      }
      .envelope-wrapper.open .letter-preview {
        z-index: 15;
        animation: letter-pop 0.8s 0.5s ease-in-out forwards;
        cursor: pointer;
      }
      @keyframes letter-pop {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(-120px); /* K√©o l√° th∆∞ l√™n */
        }
      }

      /* --- Full Letter Popup (COPY C·∫§U TR√öC V√Ä V·ªä TR√ç) --- */
      #full-letter {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }
      #full-letter.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .letter-content {
        width: 90%;
        max-width: 600px; /* To h∆°n index 1 ch√∫t cho admin */
        max-height: 85vh;
        background: #fffafa; /* M√†u gi·∫•y th∆∞ */
        border-radius: 10px;
        padding: 40px;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.5s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      #full-letter.show .letter-content {
        transform: scale(1);
      }
      .letter-content h2 {
        font-family: "Dancing Script", cursive;
        text-align: center;
        color: #d62828;
        font-size: 32px;
        margin-bottom: 20px;
      }
      .letter-content p {
        font-size: 17px;
        color: #333;
        line-height: 1.6;
        margin-bottom: 10px;
      }
      .letter-line {
        /* D√≤ng th∆∞ ƒë∆∞·ª£c t·∫°o ra cho hi·ªáu ·ª©ng type */
        opacity: 0;
        transition: opacity 0.1s;
        min-height: 1.6em; /* Gi·ªØ ch·ªó ƒë·ªÉ kh√¥ng b·ªã CLS */
      }
      .signature {
        font-family: "Dancing Script", cursive;
        text-align: right;
        font-size: 30px;
        margin-top: 30px;
        color: #d62828;
      }

      /* --- Music Control --- */
      .music-control {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 200;
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        color: var(--color-primary);
      }
      .note-anim {
        animation: musicRotate 2s linear infinite;
      }
      @keyframes musicRotate {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- Generator UI --- */
      #generator-ui {
        width: 95%;
        max-width: 600px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        transition: all 0.3s ease;
      }

      /* TAB STYLES */
      .tab-btn {
        padding: 10px 20px;
        font-weight: bold;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        cursor: pointer;
      }
      .tab-btn.active {
        color: var(--color-primary);
        border-bottom: 3px solid var(--color-primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Loading Overlay */
      #loading-overlay {
        position: fixed;
        inset: 0;
        background: white;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: #f06292;
      }

      /* Custom Alert Modal */
      #custom-alert {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10000;
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        justify-content: center;
        align-items: center;
      }
      #custom-alert.show {
        display: flex;
      }
      .alert-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 300px;
        width: 90%;
      }
      .alert-content button {
        margin-top: 15px;
        background: var(--color-primary);
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        transition: background 0.2s;
      }
      .alert-content button:hover {
        background: #d62828;
      }

      /* Mobile Reponsive */
      @media (max-width: 480px) {
        .envelope {
          width: 260px;
          height: 170px;
        }
        .envelope::before {
          width: 260px;
          height: 170px;
        }
        .flap {
          border-left-width: 130px;
          border-right-width: 130px;
        }
        .envelope::after {
          border-left-width: 130px;
          border-right-width: 130px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Nh·∫°c n·ªÅn (D√πng cho ch·∫ø ƒë·ªô xem th∆∞) -->
    <audio id="bg-music" loop>
      <source src="sound.mp3" type="audio/mpeg" />
    </audio>

    <!-- Custom Alert Modal (Thay th·∫ø cho alert()) -->
    <div id="custom-alert">
      <div class="alert-content">
        <p id="alert-message" class="text-gray-700"></p>
        <button
          onclick="document.getElementById('custom-alert').classList.remove('show');"
        >
          OK
        </button>
      </div>
    </div>

    <!-- N√∫t ƒëi·ªÅu khi·ªÉn nh·∫°c (D√πng cho ch·∫ø ƒë·ªô xem th∆∞) -->
    <div
      class="music-control hidden"
      id="music-control"
      onclick="toggleMusic()"
    >
      <i id="music-icon" class="fa-solid fa-volume-xmark"></i>
    </div>

    <!-- === PH·∫¶N 1: PHONG TH∆Ø (ENVELOPE) - V·ªä TR√ç ƒê√É FIX === -->
    <div id="envelope-container">
      <div class="envelope-wrapper" onclick="openEnvelope()">
        <div class="envelope">
          <div class="letter-preview">
            <i class="fa-solid fa-heart heart-seal"></i>
          </div>
          <div class="flap"></div>
          <div class="seal"><i class="fa-solid fa-heart"></i></div>
        </div>
      </div>
      <p
        class="absolute bottom-[-40px] text-pink-700 font-bold animate-bounce cursor-pointer"
        onclick="openEnvelope()"
      >
        Nh·∫•n ƒë·ªÉ m·ªü th∆∞ <i class="fa-solid fa-envelope-open-text ml-1"></i>
      </p>
    </div>

    <!-- === PH·∫¶N 2: GENERATOR UI (M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã) === -->
    <div id="generator-ui">
      <h1
        class="text-3xl font-bold text-center text-pink-600 mb-2 font-['Dancing_Script']"
      >
        üíå Qu·∫£n L√Ω Th∆∞ T√¨nh
      </h1>

      <!-- TAB NAVIGATION -->
      <div class="flex justify-center border-b border-gray-200 mb-6">
        <button
          id="tab-create"
          class="tab-btn active"
          onclick="switchTab('create')"
        >
          <i class="fa-solid fa-plus mr-1"></i> T·∫°o M·ªõi
        </button>
        <button id="tab-edit" class="tab-btn" onclick="switchTab('edit')">
          <i class="fa-solid fa-pen-to-square mr-1"></i> Ch·ªânh S·ª≠a
        </button>
      </div>

      <!-- EDIT MODE INPUT AREA -->
      <div
        id="edit-id-container"
        class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden"
      >
        <label class="block text-sm font-bold text-gray-700 mb-1"
          >Nh·∫≠p ID th∆∞ c·∫ßn s·ª≠a:</label
        >
        <div class="flex gap-2">
          <input
            type="text"
            id="edit-letter-id"
            placeholder="V√≠ d·ª•: -OEJ..."
            class="flex-grow rounded-md border-gray-300 border p-2 focus:border-yellow-500 outline-none"
          />
          <button
            onclick="loadLetterForEditing()"
            class="px-4 py-2 bg-yellow-500 text-white font-bold rounded hover:bg-yellow-600 transition"
            id="btn-load-id"
          >
            <i class="fa-solid fa-download"></i> T·∫£i D·ªØ Li·ªáu
          </button>
        </div>
        <p id="edit-status" class="text-xs text-gray-500 mt-1 italic"></p>
      </div>

      <!-- N√∫t Xem Th·ª≠ M·∫´u (Chung cho c·∫£ 2 tab) -->
      <div class="flex justify-center mb-6">
        <button
          onclick="togglePreview()"
          class="flex items-center space-x-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition"
        >
          <i class="fa-regular fa-eye"></i>
          <span id="preview-btn-text">Xem th·ª≠ phong b√¨ m·∫´u</span>
        </button>
      </div>

      <form id="link-form" class="space-y-4">
        <!-- Input fields -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700"
              >Ti√™u ƒë·ªÅ th∆∞</label
            >
            <input
              type="text"
              id="title"
              value="Th∆∞ T√¨nh Y√™u"
              class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:border-pink-500 outline-none"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700"
              >G·ª≠i ƒë·∫øn (L·ªùi ch√†o)</label
            >
            <input
              type="text"
              id="recipient"
              value="Em y√™u"
              class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:border-pink-500 outline-none"
              required
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700"
            >N·ªôi dung th∆∞</label
          >
          <textarea
            id="message"
            rows="6"
            class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:border-pink-500 outline-none"
            required
          >
G·ª≠i ƒë·∫øn ng∆∞·ªùi con g√°i anh y√™u th∆∞∆°ng nh·∫•t,

T·ª´ khi c√≥ em, th·∫ø gi·ªõi c·ªßa anh nh∆∞ ƒë∆∞·ª£c t√¥ th√™m ng√†n m√†u s·∫Øc. M·ªói ng√†y th·ª©c d·∫≠y, ƒëi·ªÅu ƒë·∫ßu ti√™n anh nghƒ© ƒë·∫øn l√† n·ª• c∆∞·ªùi c·ªßa em. Anh bi·∫øt ∆°n s·ªë ph·∫≠n ƒë√£ ƒë∆∞a em ƒë·∫øn b√™n anh.

Y√™u em nhi·ªÅu h∆°n nh·ªØng g√¨ con ch·ªØ c√≥ th·ªÉ n√≥i ƒë∆∞·ª£c.</textarea
          >
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700"
              >L·ªùi k·∫øt</label
            >
            <input
              type="text"
              id="conclusion"
              value="M√£i y√™u em,"
              class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:border-pink-500 outline-none"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700"
              >Ng∆∞·ªùi g·ª≠i (K√Ω t√™n)</label
            >
            <input
              type="text"
              id="sender"
              value="Anh"
              class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:border-pink-500 outline-none"
              required
            />
          </div>
        </div>

        <!-- Music -->
        <div class="border p-4 rounded-lg bg-pink-50">
          <label class="block text-sm font-bold text-pink-700 mb-2"
            >Nh·∫°c n·ªÅn (Link MP3)</label
          >
          <input
            type="url"
            id="music-url"
            placeholder="D√°n link nh·∫°c (.mp3) ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ d√πng nh·∫°c m·∫∑c ƒë·ªãnh"
            class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:border-pink-500 outline-none"
          />

          <div class="flex items-center space-x-3 my-2">
            <hr class="flex-grow border-pink-200" />
            <span class="text-xs text-pink-600">HO·∫∂C UPLOAD (Cloudinary)</span>
            <hr class="flex-grow border-pink-200" />
          </div>

          <input
            type="file"
            id="music-file"
            accept=".mp3, .m4a"
            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200"
          />
          <p id="file-status" class="text-xs text-gray-500 mt-1 italic">
            File s·∫Ω ƒë∆∞·ª£c upload l√™n Cloudinary khi nh·∫•n n√∫t L∆∞u/C·∫≠p nh·∫≠t
          </p>
        </div>

        <button
          type="button"
          id="generate-btn"
          onclick="handleFirebaseGeneration()"
          class="w-full py-3 px-4 bg-pink-500 text-white font-bold rounded-lg shadow-lg hover:bg-pink-600 transition hover:scale-[1.01]"
        >
          <i class="fa-solid fa-paper-plane mr-2"></i> L∆∞u v√† T·∫°o Link Chia S·∫ª
        </button>
      </form>

      <!-- Result -->
      <div
        id="result-container"
        class="mt-6 p-4 border border-green-400 bg-green-50 rounded-lg hidden"
      >
        <label
          id="result-label"
          class="block text-sm font-bold text-green-700 mb-2"
          >Link th∆∞:</label
        >
        <div class="flex items-center space-x-2">
          <input
            type="text"
            id="generated-link"
            readonly
            class="flex-grow rounded-md border p-2 text-sm bg-white text-gray-700"
          />
          <button
            onclick="copyLink()"
            class="p-2 bg-green-500 text-white rounded hover:bg-green-600"
          >
            <i class="fa-solid fa-copy"></i>
          </button>
        </div>
        <a
          id="test-link"
          href="#"
          target="_blank"
          class="block mt-2 text-center text-pink-600 font-bold hover:underline"
          >üëâ M·ªü th∆∞ ngay</a
        >
      </div>
    </div>

    <!-- === POPUP N·ªòI DUNG TH∆Ø (Overlay) === -->
    <div id="full-letter" onclick="hideFullLetter(event)">
      <div class="letter-content" onclick="event.stopPropagation()">
        <h2 id="final-title">Th∆∞ T√¨nh</h2>
        <p id="final-greeting" class="font-bold"></p>
        <!-- Container m·ªõi cho c√°c d√≤ng th∆∞ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông -->
        <div
          id="final-message"
          class="whitespace-pre-wrap leading-relaxed indent-8"
        >
          <!-- C√°c th·∫ª <div class="letter-line" data-full-text="..."> ƒë∆∞·ª£c JS t·∫°o ra ·ªü ƒë√¢y -->
          <div class="text-center text-gray-400 text-base italic">
            N·ªôi dung th∆∞ s·∫Ω ƒë∆∞·ª£c t·∫£i v√† hi·ªÉn th·ªã hi·ªáu ·ª©ng ƒë√°nh m√°y.
          </div>
        </div>
        <div class="signature" id="final-signature">M√£i y√™u,<br />Anh</div>
      </div>
    </div>

    <script>
      // --- LOGIC HI·ªÜU ·ª®NG ƒê√ÅNH M√ÅY (COPIED) ---
      let typingIntervals = [];
      let fullMessageHtml = ""; // Bi·∫øn l∆∞u n·ªôi dung HTML ƒë·∫ßy ƒë·ªß
      const TYPING_SPEED = 50; // T·ªëc ƒë·ªô ƒë√°nh m√°y

      // 1. H√†m type t·ª´ng ch·ªØ
      function typeLine(lineElement, text) {
        return new Promise((resolve) => {
          let i = 0;
          const interval = setInterval(() => {
            if (i < text.length) {
              lineElement.innerHTML += text.charAt(i);
              i++;
            } else {
              clearInterval(interval);
              resolve();
            }
          }, TYPING_SPEED);
          typingIntervals.push(interval);
        });
      }

      // 2. H√†m b·∫Øt ƒë·∫ßu type t·ª´ng d√≤ng
      async function startTyping(letterLines) {
        for (let i = 0; i < letterLines.length; i++) {
          const line = letterLines[i];
          const fullText = line.getAttribute("data-full-text");

          // Hi·ªán d√≤ng l√™n tr∆∞·ªõc khi type
          line.style.opacity = "1";

          await typeLine(line, fullText);
          // Th√™m m·ªôt kho·∫£ng ngh·ªâ nh·ªè gi·ªØa c√°c d√≤ng
          await new Promise((r) => setTimeout(r, 100));
        }
      }

      // 3. H√†m reset (khi ƒë√≥ng popup)
      function resetTyping() {
        typingIntervals.forEach(clearInterval);
        typingIntervals = [];
        // Kh√¥i ph·ª•c l·∫°i n·ªôi dung ƒë·∫ßy ƒë·ªß (Kh√¥ng type n·ªØa, hi·ªán ngay)
        const messageContainer = document.getElementById("final-message");
        if (messageContainer) {
          messageContainer.innerHTML = fullMessageHtml;
        }
      }

      // --- LOGIC GIAO DI·ªÜN CHUNG ---
      const fullLetter = document.getElementById("full-letter");
      const music = document.getElementById("bg-music");
      const musicIcon = document.getElementById("music-icon");
      let isPlaying = false;
      let isEnvelopeOpen = false;

      // H√†m hi·ªÉn th·ªã custom alert (Thay th·∫ø cho alert())
      window.showCustomAlert = (message) => {
        document.getElementById("alert-message").textContent = message;
        document.getElementById("custom-alert").classList.add("show");
      };

      // --- TAB SWITCHING LOGIC ---
      let currentMode = "create"; // 'create' or 'edit'
      let editingId = null;

      function switchTab(mode) {
        currentMode = mode;
        const tabCreate = document.getElementById("tab-create");
        const tabEdit = document.getElementById("tab-edit");
        const editContainer = document.getElementById("edit-id-container");
        const btn = document.getElementById("generate-btn");
        const resultContainer = document.getElementById("result-container");

        // UI Tabs
        if (mode === "create") {
          tabCreate.classList.add("active");
          tabEdit.classList.remove("active");
          editContainer.classList.add("hidden");

          // Reset form to default
          document.getElementById("link-form").reset();
          document.getElementById("title").value = "Th∆∞ T√¨nh Y√™u";
          document.getElementById("recipient").value = "Em y√™u";
          document.getElementById("conclusion").value = "M√£i y√™u em,";
          document.getElementById("sender").value = "Anh";
          document.getElementById("message").value =
            "G·ª≠i ƒë·∫øn ng∆∞·ªùi con g√°i anh y√™u th∆∞∆°ng nh·∫•t,\n\nT·ª´ khi c√≥ em, th·∫ø gi·ªõi c·ªßa anh nh∆∞ ƒë∆∞·ª£c t√¥ th√™m ng√†n m√†u s·∫Øc. M·ªói ng√†y th·ª©c d·∫≠y, ƒëi·ªÅu ƒë·∫ßu ti√™n anh nghƒ© ƒë·∫øn l√† n·ª• c∆∞·ªùi c·ªßa em. Anh bi·∫øt ∆°n s·ªë ph·∫≠n ƒë√£ ƒë∆∞a em ƒë·∫øn b√™n anh.\n\nY√™u em nhi·ªÅu h∆°n nh·ªØng g√¨ con ch·ªØ c√≥ th·ªÉ n√≥i ƒë∆∞·ª£c.";

          // Reset Button State
          btn.innerHTML =
            '<i class="fa-solid fa-paper-plane mr-2"></i> L∆∞u v√† T·∫°o Link Chia S·∫ª';
          btn.classList.remove("bg-yellow-500", "hover:bg-yellow-600");
          btn.classList.add("bg-pink-500", "hover:bg-pink-600");

          // Hide result
          resultContainer.classList.add("hidden");
          editingId = null;
        } else {
          tabCreate.classList.remove("active");
          tabEdit.classList.add("active");
          editContainer.classList.remove("hidden");

          // Focus input
          document.getElementById("edit-letter-id").focus();

          // Button Update State (initial)
          btn.innerHTML =
            '<i class="fa-solid fa-rotate mr-2"></i> C·∫≠p Nh·∫≠t Th∆∞';
          btn.classList.remove("bg-pink-500", "hover:bg-pink-600");
          btn.classList.add("bg-yellow-500", "hover:bg-yellow-600");

          resultContainer.classList.add("hidden");
        }
      }

      async function loadLetterForEditing() {
        const idInput = document.getElementById("edit-letter-id");
        const id = idInput.value.trim();
        const loadBtn = document.getElementById("btn-load-id");
        const statusText = document.getElementById("edit-status");

        if (!id) {
          window.showCustomAlert("Vui l√≤ng nh·∫≠p ID th∆∞!");
          return;
        }

        loadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        loadBtn.disabled = true;
        statusText.textContent = "ƒêang t√¨m ki·∫øm...";

        const data = await window.loadLetterFromFirebase(id);

        loadBtn.innerHTML = '<i class="fa-solid fa-download"></i> T·∫£i D·ªØ Li·ªáu';
        loadBtn.disabled = false;

        if (data) {
          editingId = id;
          statusText.textContent = `ƒê√£ t·∫£i th√†nh c√¥ng th∆∞: ${data.t}`;
          statusText.className = "text-xs text-green-600 mt-1 italic font-bold";

          // Fill data to form
          document.getElementById("title").value = data.t || "";
          document.getElementById("recipient").value = data.to || "";
          document.getElementById("message").value = data.msg || "";
          document.getElementById("conclusion").value = data.con || "";
          document.getElementById("sender").value = data.from || "";
          document.getElementById("music-url").value = data.music || "";

          window.showCustomAlert(
            "ƒê√£ t·∫£i d·ªØ li·ªáu th∆∞ th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a ngay b√¢y gi·ªù."
          );
        } else {
          editingId = null;
          statusText.textContent = "Kh√¥ng t√¨m th·∫•y th∆∞ v·ªõi ID n√†y.";
          statusText.className = "text-xs text-red-500 mt-1 italic font-bold";
          window.showCustomAlert(
            "Kh√¥ng t√¨m th·∫•y th∆∞! Vui l√≤ng ki·ªÉm tra l·∫°i ID."
          );
        }
      }

      // 1. Toggle Preview (ƒê∆∞a th∆∞ l√™n ƒë·∫ßu)
      function togglePreview() {
        const body = document.body;
        const btnText = document.getElementById("preview-btn-text");

        // √Åp d·ª•ng d·ªØ li·ªáu hi·ªán t·∫°i l√™n UI preview tr∆∞·ªõc khi hi·ªán
        const currentData = {
          t: document.getElementById("title").value,
          to: document.getElementById("recipient").value,
          msg: document.getElementById("message").value,
          con: document.getElementById("conclusion").value,
          from: document.getElementById("sender").value,
          music: document.getElementById("music-url").value,
        };
        window.applyDataToUI(currentData);
        resetTyping(); // ƒê·∫£m b·∫£o n·ªôi dung ƒë∆∞·ª£c load ƒë·∫ßy ƒë·ªß

        body.classList.toggle("show-preview");

        if (body.classList.contains("show-preview")) {
          window.scrollTo({ top: 0, behavior: "smooth" });
          btnText.textContent = "·∫®n phong b√¨ m·∫´u";
        } else {
          btnText.textContent = "Xem th·ª≠ phong b√¨ m·∫´u";
        }
      }

      // 2. M·ªü th∆∞ (ƒê√£ c·∫≠p nh·∫≠t c∆° ch·∫ø m·ªü th∆∞ v√† hi·ªáu ·ª©ng type)
      function openEnvelope() {
        const wrapper = document.querySelector(".envelope-wrapper");
        const letterLines = Array.from(
          document.querySelectorAll("#final-message .letter-line")
        );

        if (isEnvelopeOpen) {
          fullLetter.classList.add("show");
          resetTyping();
          letterLines.forEach((line) => {
            line.style.opacity = "0";
            line.innerHTML = "";
          });
          if (letterLines.length > 0) {
            startTyping(letterLines);
          }
          return;
        }

        // L·∫ßn ƒë·∫ßu m·ªü
        isEnvelopeOpen = true;
        wrapper.classList.add("open");

        setTimeout(() => {
          fullLetter.classList.add("show");

          if (letterLines.length > 0) {
            letterLines.forEach((line) => {
              line.innerHTML = "";
            });
            startTyping(letterLines);
          }
        }, 1000);
      }

      // 3. ƒê√≥ng popup khi click ra ngo√†i
      function hideFullLetter(e) {
        if (e.target.id === "full-letter") {
          fullLetter.classList.remove("show");
          resetTyping(); // D·ª´ng hi·ªáu ·ª©ng type
        }
      }

      // 4. Nh·∫°c n·ªÅn (Ch·ªâ ho·∫°t ƒë·ªông trong View Mode)
      function toggleMusic() {
        if (isPlaying) {
          music.pause();
          isPlaying = false;
          musicIcon.classList.remove("fa-volume-high", "note-anim");
          musicIcon.classList.add("fa-volume-xmark");
        } else {
          playMusic();
        }
      }

      function playMusic() {
        music
          .play()
          .then(() => {
            isPlaying = true;
            musicIcon.classList.remove("fa-volume-xmark");
            musicIcon.classList.add("fa-volume-high", "note-anim");
          })
          .catch((e) => console.log("C·∫ßn t∆∞∆°ng t√°c ƒë·ªÉ ph√°t nh·∫°c"));
      }

      // --- LOGIC X·ª¨ L√ù DATA (FIREBASE + UPLOAD) ---

      // Cloudinary config
      const CLOUD_NAME = "dys3wgutz";
      const UPLOAD_PRESET = "comic_raw_files_preset";

      async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        try {
          const res = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`,
            {
              method: "POST",
              body: formData,
            }
          );
          const data = await res.json();
          return data.secure_url;
        } catch (e) {
          console.error(e);
          window.showCustomAlert(
            "L·ªói upload nh·∫°c l√™n Cloudinary. Vui l√≤ng th·ª≠ l·∫°i."
          );
          return null;
        }
      }

      async function handleFirebaseGeneration() {
        const btn = document.getElementById("generate-btn");
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

        // 1. L·∫•y d·ªØ li·ªáu form
        const title = document.getElementById("title").value;
        const to = document.getElementById("recipient").value;
        const msg = document.getElementById("message").value;
        const con = document.getElementById("conclusion").value;
        const from = document.getElementById("sender").value;
        let musicUrl = document.getElementById("music-url").value;
        const musicFile = document.getElementById("music-file").files[0];

        if (!msg.trim()) {
          window.showCustomAlert("N·ªôi dung th∆∞ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
          btn.disabled = false;
          btn.innerHTML = originalBtnText;
          return;
        }

        // 2. Upload nh·∫°c n·∫øu c√≥ file
        if (musicFile) {
          const uploadedUrl = await uploadToCloudinary(musicFile);
          if (uploadedUrl) musicUrl = uploadedUrl;
        }

        // 3. Chu·∫©n b·ªã data object
        const letterData = {
          t: title.trim(),
          to: to.trim(),
          msg: msg, // Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng \n
          con: con.trim(),
          from: from.trim(),
          music: musicUrl.trim(),
        };

        // 4. X·ª¨ L√ù T√ôY THEO CH·∫æ ƒê·ªò (CREATE / UPDATE)
        let success = false;
        let finalId = null;

        if (currentMode === "edit" && editingId) {
          // Update
          success = await window.updateLetterToFirebase(editingId, letterData);
          finalId = editingId;
        } else {
          // Create new
          finalId = await window.saveLetterToFirebase(letterData);
          success = !!finalId;
        }

        btn.disabled = false;
        btn.innerHTML = originalBtnText;

        if (success) {
          const baseUrl = window.location.href.split("admin.html")[0];
          const finalLink = `${baseUrl}letter.html?id=${finalId}`;

          const resultContainer = document.getElementById("result-container");
          resultContainer.classList.remove("hidden");

          if (currentMode === "edit") {
            document.getElementById("result-label").textContent =
              "C·∫≠p nh·∫≠t th√†nh c√¥ng! Link c≈© v·∫´n ho·∫°t ƒë·ªông:";
            window.showCustomAlert("ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung th∆∞ th√†nh c√¥ng!");
          } else {
            document.getElementById("result-label").textContent =
              "Link ƒë√£ t·∫°o th√†nh c√¥ng:";
          }

          document.getElementById("generated-link").value = finalLink;
          document.getElementById("test-link").href = finalLink;

          // Scroll xu·ªëng result
          resultContainer.scrollIntoView({ behavior: "smooth" });

          // C·∫≠p nh·∫≠t preview UI
          window.applyDataToUI(letterData);
          // Kh√¥ng t·ª± ƒë·ªông hi·ªán preview khi edit cho ƒë·ª° r·ªëi, ch·ªâ hi·ªán result
          if (currentMode !== "edit") {
            document.body.classList.add("show-preview");
          }
        }
      }

      function copyLink() {
        const copyText = document.getElementById("generated-link");
        copyText.select();
        document.execCommand("copy");
        window.showCustomAlert("ƒê√£ sao ch√©p link!"); // D√πng custom alert
      }

      // --- H√ÄM APPLY D·ªÆ LI·ªÜU L√äN UI (KHI XEM TH∆Ø) ---
      window.applyDataToUI = (data) => {
        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang
        document.title = data.t || "Th∆∞ g·ª≠i ng∆∞·ªùi th∆∞∆°ng";
        document.getElementById("final-title").textContent = data.t;

        // C·∫≠p nh·∫≠t l·ªùi ch√†o
        document.getElementById(
          "final-greeting"
        ).textContent = `G·ª≠i ${data.to},`;

        // C·∫≠p nh·∫≠t ch·ªØ k√Ω
        document.getElementById(
          "final-signature"
        ).innerHTML = `${data.con}<br>${data.from}`;

        // C·∫≠p nh·∫≠t nh·∫°c (Ch·ªâ √°p d·ª•ng n·∫øu c√≥ URL)
        if (data.music && music) {
          music.src = data.music;
          music.load();
        }

        // C·∫≠p nh·∫≠t n·ªôi dung: Ph√¢n t√≠ch v√† t·∫°o d√≤ng cho hi·ªáu ·ª©ng type
        const rawMsg = data.msg || "";
        // Ph√¢n t√°ch theo d√≤ng m·ªõi \n. Th√™m m·ªôt d√≤ng tr·ªëng ·ªü ƒë·∫ßu v√† cu·ªëi cho ƒë·∫πp
        const lines = ["", ...rawMsg.split("\n"), ""];

        const messageContainer = document.getElementById("final-message");

        // X√≥a n·ªôi dung c≈©
        messageContainer.innerHTML = "";
        fullMessageHtml = ""; // Reset bi·∫øn to√†n c·ª•c ch·ª©a HTML ƒë·∫ßy ƒë·ªß

        lines.forEach((line) => {
          // X·ª≠ l√Ω d√≤ng tr·ªëng ƒë·ªÉ t·∫°o kho·∫£ng c√°ch gi·ªØa c√°c ƒëo·∫°n
          const textContent = line.trim() === "" ? "\u00A0" : line.trim(); // D√πng non-breaking space

          const lineDiv = document.createElement("div");
          lineDiv.className = "letter-line";
          lineDiv.setAttribute("data-full-text", textContent);
          lineDiv.style.opacity = "0"; // M·∫∑c ƒë·ªãnh ·∫©n

          messageContainer.appendChild(lineDiv);

          // L∆∞u l·∫°i n·ªôi dung HTML ƒë·∫ßy ƒë·ªß
          fullMessageHtml += `<div class="letter-line" style="min-height: 1.6em;">${textContent}</div>`;
        });
      };
    </script>
  </body>
</html>
