<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G·ª≠i Ng∆∞·ªùi Th∆∞∆°ng | Link T√πy Ch·ªânh To√†n B·ªô</title>
    <!-- Tailwind CSS CDN cho styling hi·ªán ƒë·∫°i -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Nunito:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
      /* --- C·∫•u h√¨nh Tailwind + Font chung --- */
      :root {
        --color-primary: #f06292; /* H·ªìng ƒë·∫≠m */
        --color-secondary: #ffcdd2; /* H·ªìng nh·∫°t */
        --color-bg: #fce4ec; /* Background si√™u nh·∫°t */
      }
      * {
        box-sizing: border-box;
      }
      body {
        height: 100vh;
        width: 100vw;
        background-color: var(--color-bg);
        background-image: linear-gradient(135deg, #fce4ec 0%, #f7a2b9 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        font-family: "Nunito", sans-serif;
        position: relative;
        transition: opacity 0.5s;
      }
      /* ·∫®n Generator khi xem Link ƒë√£ t·∫°o */
      .is-custom-link #generator-ui {
        display: none !important;
      }
      /* ·∫®n Envelope khi ·ªü ch·∫ø ƒë·ªô Generator */
      #generator-ui:not(:hidden) ~ .envelope-wrapper {
        display: none;
      }

      /* --- Hi·ªáu ·ª©ng tim bay n·ªÅn (Background Particles) --- */
      .bg-heart {
        position: absolute;
        top: -10vh;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(2px);
        border-radius: 50%;
        pointer-events: none;
        animation: fall linear infinite;
        font-size: 20px;
        color: var(--color-secondary);
      }
      @keyframes fall {
        0% {
          transform: translateY(-10vh) translateX(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(110vh) translateX(20px) rotate(360deg);
          opacity: 0;
        }
      }

      /* --- Kh·ªëi Phong Th∆∞ (Envelope) --- */
      .envelope-wrapper {
        position: relative;
        cursor: pointer;
        transition: transform 0.3s;
        perspective: 1000px;
        z-index: 50;
      }
      .envelope-wrapper:hover {
        transform: scale(1.02);
      }
      .envelope {
        position: relative;
        width: 300px;
        height: 200px;
        background: var(--color-secondary);
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        z-index: 20;
        transition: background 0.5s;
      }
      .envelope::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 150px solid transparent;
        border-right: 150px solid transparent;
        border-bottom: 100px solid var(--color-primary);
        border-radius: 0 0 8px 8px;
        z-index: 20;
        pointer-events: none;
        transition: border-bottom-color 0.5s;
      }
      .envelope::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 300px;
        height: 200px;
        background: var(--color-secondary);
        z-index: 20;
        pointer-events: none;
        border-radius: 8px;
        transition: background 0.5s;
      }
      .letter-preview {
        position: absolute;
        width: 270px;
        height: 140px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        transition: transform 0.8s ease-in-out, z-index 0.1s, opacity 0.5s;
      }
      .letter-preview.in-pocket {
        top: 90px;
        left: 15px;
        opacity: 0;
        z-index: 25;
      }
      .letter-preview .heart-seal {
        font-size: 30px;
        color: var(--color-secondary);
        opacity: 1;
      }
      .flap {
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 150px solid transparent;
        border-right: 150px solid transparent;
        border-top: 120px solid var(--color-primary);
        transform-origin: top;
        transition: transform 0.6s 0.4s ease-in-out;
        z-index: 30;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .seal {
        position: absolute;
        top: 110px;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        background: #d32f2f;
        border-radius: 50%;
        z-index: 40;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 10px;
        cursor: pointer;
        transition: opacity 0.4s 0.2s, transform 0.3s;
      }
      .seal i {
        font-size: 10px;
      }
      .envelope-wrapper.open .flap {
        transform: rotateX(180deg);
        z-index: 1;
      }
      .envelope-wrapper.open .seal {
        opacity: 0;
        pointer-events: none;
      }
      .envelope-wrapper.open .letter-preview {
        top: 10px;
        left: 15px;
        opacity: 1;
        cursor: pointer;
        z-index: 15;
        animation: letter-pop 0.8s 0.5s ease-in-out forwards;
      }
      @keyframes letter-pop {
        0% {
          transform: translateY(0);
          opacity: 1;
        }
        60% {
          transform: translateY(-110px);
        }
        100% {
          transform: translateY(-80px);
        }
      }
      .envelope-wrapper.open .letter-preview:hover {
        transform: translateY(-85px);
        box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.1);
      }
      /* --- N·ªôi dung Th∆∞ (Popup) --- */
      #full-letter {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      #full-letter.show {
        opacity: 1;
        pointer-events: auto;
      }
      .paper {
        width: 90%;
        max-width: 400px;
        height: 80vh;
        background: #fffafa;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        padding: 25px;
        position: relative;
        overflow-y: auto;
        overflow-x: hidden;
        transform: scale(0.8);
        transition: transform 0.5s ease;
        background-image: repeating-linear-gradient(
          white 0px,
          white 24px,
          #e1e1e1 25px
        );
        line-height: 25px;
        cursor: grab; /* Th√™m cursor k√©o/l∆∞·ªõt */
        touch-action: none; /* NgƒÉn ch·∫∑n pull-to-refresh tr√™n mobile */
      }
      #full-letter.show .paper {
        transform: scale(1);
      }
      .paper::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }
      .paper-content {
        margin-top: 10px;
      }
      .paper h2 {
        font-family: "Dancing Script", cursive;
        text-align: center;
        color: #d62828;
        font-size: 28px;
        margin-bottom: 20px;
        line-height: 1.2;
      }
      .paper p,
      .signature {
        font-family: "Nunito", sans-serif;
        color: #4a4a4a;
        font-size: 16px;
        text-align: justify;
        margin-bottom: 15px;
        white-space: pre-wrap;
        opacity: 0;
        display: block;
        transition: opacity 0.1s;
      }
      .signature {
        font-family: "Dancing Script", cursive;
        text-align: right;
        font-size: 24px;
        margin-top: 30px;
        color: #d62828;
      }
      /* --- ƒêi·ªÅu khi·ªÉn Nh·∫°c --- */
      .music-control {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 200;
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        color: var(--color-primary);
      }
      .note-anim {
        animation: musicRotate 2s linear infinite;
      }
      @keyframes musicRotate {
        0% {
          transform: rotate(0deg) scale(1);
        }
        50% {
          transform: rotate(180deg) scale(1.2);
        }
        100% {
          transform: rotate(360deg) scale(1);
        }
      }
      @media (max-width: 480px) {
        .envelope {
          width: 260px;
          height: 170px;
        }
        .flap {
          border-left-width: 130px;
          border-right-width: 130px;
          border-top-width: 105px;
        }
        .envelope::after {
          border-left-width: 130px;
          border-right-width: 130px;
          border-bottom-width: 85px;
        }
        .envelope::before {
          width: 260px;
          height: 170px;
        }
        .letter-preview {
          width: 230px;
          height: 120px;
        }
        .letter-preview.in-pocket {
          top: 75px;
          left: 15px;
        }
        .seal {
          top: 95px;
        }
        .paper {
          max-width: 350px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Nh·∫°c n·ªÅn (S·∫Ω ƒë∆∞·ª£c thay ƒë·ªïi b·∫±ng JS n·∫øu c√≥ tham s·ªë music) -->
    <audio id="bg-music" loop>
      <!-- M·∫∑c ƒë·ªãnh (N·∫øu kh√¥ng c√≥ tham s·ªë music) -->
      <source src="sound.m4a" type="audio/mp4" />
      <source src="sound.mp3" type="audio/mpeg" />
    </audio>

    <!-- N√∫t ƒëi·ªÅu khi·ªÉn nh·∫°c -->
    <div class="music-control" onclick="toggleMusic()">
      <i id="music-icon" class="fa-solid fa-volume-xmark"></i>
    </div>

    <!-- Hi·ªáu ·ª©ng tim bay -->
    <div id="hearts-container"></div>

    <!-- --- Giao di·ªán T·∫°o Link C√° Nh√¢n H√≥a (Generator UI) --- -->
    <div
      id="generator-ui"
      class="w-11/12 max-w-lg p-6 md:p-8 bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl transition duration-500 ease-in-out z-10"
    >
      <h1
        class="text-3xl font-bold text-center text-pink-600 mb-6 font-['Dancing_Script']"
      >
        üíå T·∫°o Th∆∞ T√¨nh & Link C√° Nh√¢n
      </h1>
      <form id="link-form" class="space-y-4">
        <!-- Input Ti√™u ƒë·ªÅ -->
        <div>
          <label for="title" class="block text-sm font-semibold text-gray-700"
            >Ti√™u ƒë·ªÅ th∆∞ (Parameter: t)</label
          >
          <input
            type="text"
            id="title"
            value="Th∆∞ T√¨nh Y√™u"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-pink-500 focus:ring-pink-500"
            required
          />
        </div>
        <!-- Input Ng∆∞·ªùi nh·∫≠n -->
        <div>
          <label
            for="recipient"
            class="block text-sm font-semibold text-gray-700"
            >L·ªùi ch√†o (Parameter: to)</label
          >
          <input
            type="text"
            id="recipient"
            value="v·ª£ y√™u"
            placeholder="V√≠ d·ª•: v·ª£ y√™u, √¥ng x√£, T√™n ng∆∞·ªùi ·∫•y..."
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-pink-500 focus:ring-pink-500"
            required
          />
          <p class="text-xs text-gray-500 mt-1">
            *Th∆∞ s·∫Ω b·∫Øt ƒë·∫ßu b·∫±ng: "G·ª≠i [L·ªùi ch√†o],"
          </p>
        </div>
        <!-- Input N·ªôi dung -->
        <div>
          <label for="message" class="block text-sm font-semibold text-gray-700"
            >N·ªôi dung th∆∞ (Parameter: msg)</label
          >
          <textarea
            id="message"
            rows="6"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-pink-500 focus:ring-pink-500"
            required
          >
H√¥m nay kh√¥ng ph·∫£i d·ªãp g√¨ ƒë·∫∑c bi·ªát c·∫£, nh∆∞ng em ch·ªâ mu·ªën g·ª≠i ƒë·∫øn anh l·ªùi nh·∫Øn n√†y. Em mu·ªën anh bi·∫øt r·∫±ng em y√™u anh r·∫•t nhi·ªÅu. D√π kho·∫£ng c√°ch c√≥ xa, em v·∫´n mu·ªën anh c·∫£m th·∫•y m·ªôt ch√∫t ·∫•m √°p, mong anh gi·ªØ g√¨n s·ª©c kho·∫ª, gi·ªØ b√¨nh y√™n trong l√≤ng, v√† lu√¥n nh·ªõ r·∫±ng em ƒëang ƒë·ª£i anh. Ch√∫c anh m·ªói ng√†y ƒë·ªÅu may m·∫Øn v√† h·∫°nh ph√∫c h∆°n h√¥m qua.

Em mong r·∫±ng th∆∞ n√†y s·∫Ω mang l·∫°i ni·ªÅm vui cho anh, y√™u anh h∆°n t·ª´ng ng√†y!</textarea
          >
        </div>
        <!-- Input L·ªùi k·∫øt -->
        <div>
          <label
            for="conclusion"
            class="block text-sm font-semibold text-gray-700"
            >L·ªùi k·∫øt tr∆∞·ªõc ch·ªØ k√Ω (Parameter: con)</label
          >
          <input
            type="text"
            id="conclusion"
            value="Y√™u th∆∞∆°ng nh·∫•t,"
            placeholder="V√≠ d·ª•: G·ª≠i ng∆∞·ªùi em th∆∞∆°ng, Tr√¢n tr·ªçng,"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-pink-500 focus:ring-pink-500"
            required
          />
        </div>
        <!-- Input Ch·ªØ k√Ω -->
        <div>
          <label for="sender" class="block text-sm font-semibold text-gray-700"
            >Ch·ªØ k√Ω/Ng∆∞·ªùi g·ª≠i (Parameter: from)</label
          >
          <input
            type="text"
            id="sender"
            value="ABC"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-pink-500 focus:ring-pink-500"
            required
          />
        </div>

        <!-- Input Link Nh·∫°c / T·∫£i file MP3 (Cloudinary) -->
        <div class="border p-4 rounded-lg bg-pink-50">
          <label for="music" class="block text-sm font-bold text-pink-700 mb-2"
            >√Çm nh·∫°c n·ªÅn (Parameter: music)</label
          >

          <!-- T√πy ch·ªçn 1: Link nh·∫°c (URL) -->
          <input
            type="url"
            id="music-url"
            placeholder="D√°n Link nh·∫°c (MP3/M4A/OGG) tr·ª±c ti·∫øp ·ªü ƒë√¢y (∆Øu ti√™n)"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-pink-500 focus:ring-pink-500"
          />

          <div class="flex items-center space-x-3 my-2">
            <hr class="flex-grow border-pink-200" />
            <span class="text-xs text-pink-600 font-semibold"
              >HO·∫∂C (S·ª≠ d·ª•ng Cloudinary)</span
            >
            <hr class="flex-grow border-pink-200" />
          </div>

          <!-- T√πy ch·ªçn 2: T·∫£i file MP3 c·ª•c b·ªô -->
          <input
            type="file"
            id="music-file"
            accept=".mp3"
            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200"
          />
          <p id="file-status" class="text-xs text-gray-600 mt-1 italic">
            (T·ªáp tin s·∫Ω ƒë∆∞·ª£c t·∫£i l√™n Cloudinary sau khi nh·∫•n "T·∫°o Link")
          </p>
        </div>

        <button
          type="button"
          id="generate-btn"
          onclick="handleLinkGeneration()"
          class="w-full py-3 px-4 bg-pink-500 text-white font-semibold rounded-lg shadow-lg hover:bg-pink-600 transition duration-300 transform hover:scale-[1.01]"
        >
          <i class="fa-solid fa-link mr-2"></i>T·∫°o Link C√° Nh√¢n H√≥a
        </button>
      </form>

      <!-- K·∫øt qu·∫£ Link -->
      <div
        id="result-container"
        class="mt-6 p-4 border border-green-400 bg-green-50 rounded-lg hidden"
      >
        <label class="block text-sm font-semibold text-green-700 mb-2"
          >Link c·ªßa b·∫°n (Copy v√† g·ª≠i ƒëi!)</label
        >
        <div class="flex items-center space-x-2">
          <input
            type="text"
            id="generated-link"
            readonly
            class="flex-grow rounded-md border-gray-300 shadow-sm p-2 text-sm bg-white cursor-text"
          />
          <button
            onclick="copyLink()"
            class="p-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-150"
          >
            <i class="fa-solid fa-copy"></i>
          </button>
        </div>
        <p
          id="copy-message"
          class="text-xs text-green-500 mt-2 opacity-0 transition duration-300"
        >
          ƒê√£ sao ch√©p!
        </p>
        <a
          id="test-link"
          target="_blank"
          class="mt-3 inline-block text-sm text-pink-600 hover:text-pink-800 underline transition duration-150"
          >M·ªü th·ª≠ Link n√†y</a
        >
      </div>

      <!-- Loading Indicator -->
      <div
        id="loading-indicator"
        class="mt-4 p-3 bg-blue-100 text-blue-700 rounded-lg hidden"
      >
        <i class="fa-solid fa-cloud-arrow-up fa-spin mr-2"></i> ƒêang t·∫£i t·ªáp MP3
        l√™n Cloudinary... Vui l√≤ng ch·ªù.
      </div>
    </div>
    <!-- --- H·∫øt Giao di·ªán T·∫°o Link --- -->

    <!-- Phong th∆∞ (Ch·ªâ hi·ªÉn th·ªã khi xem link ƒë√£ t·∫°o) -->
    <div class="envelope-wrapper" onclick="openEnvelope()">
      <div class="envelope">
        <!-- L√° th∆∞ b√™n trong (Preview) -->
        <div
          id="letter-preview"
          class="letter-preview in-pocket"
          onclick="showFullLetter(event)"
        >
          <i class="fa-solid fa-heart heart-seal"></i>
        </div>

        <!-- N·∫Øp phong b√¨ (Ph·∫£i l√† m·ªôt th·∫ª ri√™ng ƒë·ªÉ l·∫≠t) -->
        <div class="flap"></div>

        <!-- Tem tr√°i tim kh√≥a phong b√¨ -->
        <div class="seal">
          <i class="fa-solid fa-heart"></i>
        </div>
      </div>
    </div>

    <!-- N·ªôi dung th∆∞ ƒë·∫ßy ƒë·ªß (Popup) -->
    <!-- X√≥a onclick="hideFullLetter(event)" ƒë·ªÉ ch·ªâ d√πng touch/swipe ho·∫∑c click v√†o dark overlay -->
    <div id="full-letter">
      <div class="paper" onclick="event.stopPropagation()">
        <div class="paper-content">
          <h2 id="custom-title">Th∆∞ T√¨nh Y√™u</h2>

          <!-- D√≤ng 1: L·ªùi ch√†o (Customizable: to) -->
          <p
            class="letter-line"
            data-text="G·ª≠i ng∆∞·ªùi th∆∞∆°ng,"
            id="greeting-line"
          >
            G·ª≠i ng∆∞·ªùi th∆∞∆°ng,
          </p>

          <!-- D√≤ng 2: N·ªôi dung ch√≠nh (Customizable: msg) -->
          <p
            class="letter-line"
            data-text="[N·ªôi dung th∆∞ s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ link t√πy ch·ªânh]"
            id="body-line"
          >
            [N·ªôi dung th∆∞ s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ link t√πy ch·ªânh]
          </p>

          <!-- Ch·ªØ k√Ω (Customizable: con, from) -->
          <div
            class="signature letter-line"
            data-text="Y√™u th∆∞∆°ng nh·∫•t,<br>ABC"
            id="signature-line"
          >
            Y√™u th∆∞∆°ng nh·∫•t,<br />
            ABC
          </div>
        </div>
      </div>
    </div>

    <script>
      // =================================================================
      // === C·∫§U H√åNH CLOUDINARY (QUAN TR·ªåNG: PH·∫¢I THAY TH·∫æ GI√Å TR·ªä GI·∫¢) ===
      // =================================================================
      const CLOUD_NAME = "dys3wgutz"; // <-- THAY TH·∫æ B·∫∞NG CLOUD NAME C·ª¶A B·∫†N
      const UPLOAD_PRESET = "comic_raw_files_preset"; // <-- THAY TH·∫æ B·∫∞NG UPLOAD PRESET (PH·∫¢I L√Ä UNSIGNED)

      // --- C·∫•u h√¨nh chung ---
      const TYPING_SPEED = 30; // ms per character
      const MUSIC_MAX_SIZE = 5 * 1024 * 1024; // Gi·ªõi h·∫°n 5MB
      let isEnvelopeOpen = false;
      let isTyping = false;
      let typingTimeoutId = null;
      let isUploading = false;

      // C√°c elements
      const music = document.getElementById("bg-music");
      const musicIcon = document.getElementById("music-icon");
      const fullLetter = document.getElementById("full-letter");
      const letterLines = document.querySelectorAll(".letter-line");
      const letterPreview = document.getElementById("letter-preview");
      const generatorUI = document.getElementById("generator-ui");
      const customTitleEl = document.getElementById("custom-title");
      const greetingLineEl = document.getElementById("greeting-line");
      const bodyLineEl = document.getElementById("body-line");
      const signatureLineEl = document.getElementById("signature-line");
      const generatedLinkInput = document.getElementById("generated-link");
      const musicFileEl = document.getElementById("music-file");
      const fileStatusEl = document.getElementById("file-status");
      const generateBtn = document.getElementById("generate-btn");
      const loadingIndicator = document.getElementById("loading-indicator");
      const paperEl = document.querySelector(".paper");

      // --- Logic T·∫£i File l√™n Cloudinary (Ch√≠nh) ---
      async function uploadFileToCloudinary(file) {
        if (
          CLOUD_NAME === "your_cloud_name_here" ||
          UPLOAD_PRESET === "unsigned_preset_name"
        ) {
          // alert thay b·∫±ng console.error ƒë·ªÉ tr√°nh l·ªói tr√™n iFrame
          console.error(
            "L·ªñI C·∫§U H√åNH: Vui l√≤ng thay th·∫ø CLOUD_NAME v√† UPLOAD_PRESET trong m√£ ngu·ªìn."
          );
          return null;
        }

        if (file.size > MUSIC_MAX_SIZE) {
          console.error(
            `T·ªáp nh·∫°c qu√° l·ªõn (${(file.size / (1024 * 1024)).toFixed(
              1
            )}MB). Vui l√≤ng ch·ªçn t·ªáp d∆∞·ªõi 5MB.`
          );
          return null;
        }

        const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        isUploading = true;
        generateBtn.disabled = true;
        loadingIndicator.classList.remove("hidden");
        fileStatusEl.textContent = `üîä ƒêang t·∫£i l√™n: ${file.name}...`;

        try {
          const response = await fetch(url, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          isUploading = false;
          generateBtn.disabled = false;
          loadingIndicator.classList.add("hidden");

          if (data.secure_url) {
            fileStatusEl.textContent = `‚úÖ T·∫£i l√™n th√†nh c√¥ng! URL: ${data.secure_url.substring(
              0,
              40
            )}...`;
            fileStatusEl.classList.remove("text-red-500");
            fileStatusEl.classList.add("text-green-600");
            return data.secure_url;
          } else {
            console.error("Cloudinary upload error:", data);
            fileStatusEl.textContent =
              "‚ùå L·ªói t·∫£i l√™n. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra c·∫•u h√¨nh.";
            fileStatusEl.classList.add("text-red-500");
            return null;
          }
        } catch (error) {
          console.error("L·ªói k·∫øt n·ªëi Cloudinary:", error);
          isUploading = false;
          generateBtn.disabled = false;
          loadingIndicator.classList.add("hidden");
          fileStatusEl.textContent =
            "‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra internet.";
          fileStatusEl.classList.add("text-red-500");
          return null;
        }
      }

      // --- Logic T·∫°o Link (Generator Mode) ---
      async function handleLinkGeneration() {
        const musicFile = musicFileEl.files[0];
        const musicUrlVal = document.getElementById("music-url").value.trim();
        let finalMusicUrl = musicUrlVal;

        // 1. Ki·ªÉm tra n·ªôi dung b·∫Øt bu·ªôc
        const titleVal = document.getElementById("title").value;
        const recipientVal = document.getElementById("recipient").value;
        const messageVal = document.getElementById("message").value;
        const conclusionVal = document.getElementById("conclusion").value;
        const senderVal = document.getElementById("sender").value;

        if (
          !titleVal ||
          !recipientVal ||
          !messageVal ||
          !conclusionVal ||
          !senderVal
        ) {
          console.error(
            "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Ti√™u ƒë·ªÅ, L·ªùi ch√†o, N·ªôi dung, L·ªùi k·∫øt v√† Ch·ªØ k√Ω."
          );
          return;
        }

        // 2. X·ª≠ l√Ω t·∫£i file n·∫øu c√≥
        if (musicFile) {
          if (isUploading) {
            console.warn("ƒêang t·∫£i file l√™n Cloudinary, vui l√≤ng ch·ªù...");
            return;
          }
          finalMusicUrl = await uploadFileToCloudinary(musicFile);
          if (!finalMusicUrl) {
            // Upload th·∫•t b·∫°i ho·∫∑c l·ªói c·∫•u h√¨nh
            return;
          }
        }

        // 3. T·∫°o Link
        generateLink(
          titleVal,
          recipientVal,
          messageVal,
          conclusionVal,
          senderVal,
          finalMusicUrl
        );
      }

      function generateLink(
        titleVal,
        recipientVal,
        messageVal,
        conclusionVal,
        senderVal,
        musicUrl
      ) {
        // L·∫•y ƒë∆∞·ªùng d·∫´n g·ªëc c·ªßa trang
        const baseUrl = window.location.href.split("?")[0];

        // M√£ h√≥a c√°c tham s·ªë
        const params = new URLSearchParams();
        params.append("t", titleVal);
        params.append("to", recipientVal);
        params.append("msg", messageVal.replace(/\n/g, "\n")); // Gi·ªØ l·∫°i \n
        params.append("con", conclusionVal);
        params.append("from", senderVal);

        if (musicUrl) {
          params.append("music", musicUrl); // D√πng URL t·ª´ Cloudinary ho·∫∑c URL tr·ª±c ti·∫øp
        }

        const finalLink = `${baseUrl}?${params.toString()}`;

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        document.getElementById("result-container").classList.remove("hidden");
        generatedLinkInput.value = finalLink;
        document.getElementById("test-link").href = finalLink;

        // Cu·ªôn xu·ªëng ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y link
        generatorUI.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function copyLink() {
        generatedLinkInput.select();
        document.execCommand("copy"); // Sao ch√©p v√†o clipboard

        const msg = document.getElementById("copy-message");
        msg.classList.add("opacity-100");
        setTimeout(() => {
          msg.classList.remove("opacity-100");
        }, 1500);
      }

      // --- H√†m Ti·ªán √çch (X·ª≠ l√Ω Tham s·ªë URL) ---
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        const results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      // --- √Åp d·ª•ng N·ªôi dung T√πy ch·ªânh (View Mode) ---
      function applyCustomContent() {
        const customTitle = getUrlParameter("t");
        const customTo = getUrlParameter("to");
        const customMsg = getUrlParameter("msg");
        const customCon = getUrlParameter("con"); // L·ªùi k·∫øt m·ªõi
        const customFrom = getUrlParameter("from");
        const customMusicUrl = getUrlParameter("music"); // D√πng URL t·ª´ Cloudinary

        let isCustomLink = false;

        // 1. Update Title
        if (customTitle) {
          customTitleEl.textContent = customTitle;
          document.title = customTitle;
          isCustomLink = true;
        }

        // 2. Update Greeting (First line)
        if (customTo) {
          const newGreeting = `G·ª≠i ${customTo},`;
          greetingLineEl.setAttribute("data-text", newGreeting);
          isCustomLink = true;
        }

        // 3. Update Body (Second line)
        if (customMsg) {
          const cleanMsg = customMsg.replace(/<br\s*\/?>/gi, "\n");
          bodyLineEl.setAttribute("data-text", cleanMsg);
          isCustomLink = true;
        }

        // 4. Update Signature (Last line)
        if (customCon && customFrom) {
          const newSignature = `${customCon}<br>${customFrom}`;
          signatureLineEl.setAttribute("data-text", newSignature);
          signatureLineEl.innerHTML = newSignature;
          isCustomLink = true;
        } else if (customFrom) {
          const defaultCon = getUrlParameter("con") || "Y√™u th∆∞∆°ng nh·∫•t,";
          const newSignature = `${defaultCon}<br>${customFrom}`;
          signatureLineEl.setAttribute("data-text", newSignature);
          signatureLineEl.innerHTML = newSignature;
          isCustomLink = true;
        }

        // 5. Update Music (D√πng URL t·ª´ tham s·ªë music)
        if (customMusicUrl) {
          music.innerHTML = `<source src="${customMusicUrl}" type="audio/mpeg" onerror="console.error('L·ªói t·∫£i nh·∫°c: Kh√¥ng t√¨m th·∫•y ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£.');">`;
          music.load(); // T·∫£i nh·∫°c m·ªõi
          isCustomLink = true;
        }

        // 6. ·∫®n Generator v√† Hi·ªán Phong Th∆∞ n·∫øu ƒë√¢y l√† Link ƒë√£ t·∫°o
        if (isCustomLink) {
          document.body.classList.add("is-custom-link");
        }
      }

      // --- Kh·ªüi t·∫°o ---
      applyCustomContent();

      // --- C√°c h√†m Envelope v√† Typewriter (Gi·ªØ nguy√™n) ---

      function createHeart() {
        const container = document.getElementById("hearts-container");
        const heart = document.createElement("div");
        heart.classList.add("bg-heart");

        const left = Math.random() * 100;
        const duration = Math.random() * 5 + 5;

        heart.innerHTML = '<i class="fa-solid fa-heart"></i>';
        heart.style.left = left + "vw";
        heart.style.animationDuration = duration + "s";

        container.appendChild(heart);

        setTimeout(() => {
          heart.remove();
        }, duration * 1000);
      }

      // Ch·ªâ t·∫°o hi·ªáu ·ª©ng tim bay khi ·ªü ch·∫ø ƒë·ªô xem link
      if (document.body.classList.contains("is-custom-link")) {
        setInterval(createHeart, 600);
      }

      function openEnvelope() {
        if (isEnvelopeOpen) return;

        isEnvelopeOpen = true;

        const wrapper = document.querySelector(".envelope-wrapper");
        wrapper.classList.add("open");

        letterPreview.classList.remove("in-pocket");

        playMusic();
      }

      function resetTyping() {
        if (typingTimeoutId) {
          clearTimeout(typingTimeoutId);
          typingTimeoutId = null;
        }
        isTyping = false;

        letterLines.forEach((line) => {
          const originalText = line.getAttribute("data-text");
          // Kh√¥i ph·ª•c n·ªôi dung tƒ©nh (kh√¥ng c√≥ hi·ªáu ·ª©ng) ƒë·ªÉ tr√°nh l·ªói n·∫øu ng∆∞·ªùi d√πng ƒë√≥ng th∆∞ nhanh
          line.innerHTML = originalText.replace(/\n/g, "<br>");
          line.style.opacity = "0";
        });
      }

      function typeLine(element, text) {
        return new Promise((resolve) => {
          if (!isTyping || fullLetter.classList.contains("show") === false) {
            resolve();
            return;
          }

          let i = 0;
          element.innerHTML = "";
          element.style.opacity = "1";

          function typeChar() {
            if (!isTyping || fullLetter.classList.contains("show") === false) {
              resolve();
              return;
            }

            if (i < text.length) {
              const char = text.charAt(i);

              if (text.substring(i, i + 4) === "<br>") {
                // X·ª≠ l√Ω th·∫ª <br> (v√≠ d·ª•: trong ch·ªØ k√Ω)
                element.innerHTML += "<br>";
                i += 4;
              } else if (text.substring(i, i + 1) === "\n") {
                // X·ª≠ l√Ω xu·ªëng d√≤ng (\n) cho n·ªôi dung th√¢n th∆∞
                element.innerHTML += "<br>";
                i += 1;
              } else {
                element.innerHTML += char;
                i++;
              }

              typingTimeoutId = setTimeout(typeChar, TYPING_SPEED);
            } else {
              resolve();
            }
          }

          typeChar();
        });
      }

      async function startTyping(lines) {
        if (isTyping) return;
        isTyping = true;

        for (let i = 0; i < lines.length; i++) {
          if (!isTyping || fullLetter.classList.contains("show") === false)
            break;

          const line = lines[i];
          const originalText = line.getAttribute("data-text");

          await typeLine(line, originalText);

          if (isTyping && i < lines.length - 1) {
            await new Promise((resolve) => {
              typingTimeoutId = setTimeout(resolve, 500);
            });
          }
        }
        if (isTyping) {
          isTyping = false;
        }
      }

      function showFullLetter(e) {
        e.stopPropagation();

        if (isEnvelopeOpen) {
          fullLetter.classList.add("show");

          // ƒê·∫£m b·∫£o t·∫•t c·∫£ ch·ªØ b·ªã ·∫©n tr∆∞·ªõc khi type
          letterLines.forEach((line) => {
            line.style.opacity = "0";
            line.innerHTML = "";
          });

          // B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng ƒë√°nh m√°y
          startTyping(letterLines);
        }
      }

      // --- ƒê√£ t·ªëi ∆∞u h√≥a: Ch·ªâ ·∫©n popup v√† reset typing ---
      function hideFullLetter() {
        fullLetter.classList.remove("show");
        resetTyping();
      }

      // G·∫Øn s·ª± ki·ªán click v√†o v√πng t·ªëi (ƒë·ªÉ ƒë√≥ng th∆∞)
      fullLetter.addEventListener("click", (e) => {
        // Ch·ªâ ƒë√≥ng khi click tr·ª±c ti·∫øp v√†o #full-letter (v√πng t·ªëi)
        if (e.target.id === "full-letter") {
          hideFullLetter();
        }
      });

      // --- Logic L∆∞·ªõt/Vu·ªët (Swiping UI cho Mobile) ---
      let startY = 0;
      const SWIPE_THRESHOLD = 100; // Ng∆∞·ª°ng vu·ªët xu·ªëng ƒë·ªÉ ƒë√≥ng (pixels)

      paperEl.addEventListener("touchstart", (e) => {
        // Ch·ªâ b·∫Øt ƒë·∫ßu vu·ªët n·∫øu l√† ch·∫°m ƒë∆°n
        if (e.touches.length === 1) {
          startY = e.touches[0].clientY;
          paperEl.style.transition = "none"; // T·∫Øt transition khi ƒëang vu·ªët
        }
      });

      paperEl.addEventListener("touchmove", (e) => {
        // NgƒÉn ch·∫∑n cu·ªôn trang m·∫∑c ƒë·ªãnh khi vu·ªët
        if (e.touches.length === 1) {
          const currentY = e.touches[0].clientY;
          const deltaY = currentY - startY;

          if (deltaY > 0) {
            // Ch·ªâ cho ph√©p vu·ªët xu·ªëng
            e.preventDefault();
            // Di chuy·ªÉn gi·∫•y theo ng√≥n tay
            paperEl.style.transform = `translateY(${deltaY}px) scale(1)`;
          }
        }
      });

      paperEl.addEventListener("touchend", (e) => {
        // Kh√¥i ph·ª•c transition ƒë·ªÉ ƒë√≥ng/ƒë∆∞a v·ªÅ v·ªã tr√≠ c≈© m∆∞·ª£t m√†
        paperEl.style.transition =
          "transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)";

        if (e.changedTouches.length === 1) {
          const endY = e.changedTouches[0].clientY;
          const deltaY = endY - startY;

          if (deltaY > SWIPE_THRESHOLD) {
            // ƒê·∫°t ng∆∞·ª°ng: ƒê√≥ng th∆∞

            // T·∫°o hi·ªáu ·ª©ng tr∆∞·ª£t ra ngo√†i
            paperEl.style.transform = `translateY(${window.innerHeight}px) scale(1)`;

            // Sau khi tr∆∞·ª£t, ·∫©n popup v√† reset v·ªã tr√≠ cho l·∫ßn m·ªü ti·∫øp theo
            setTimeout(() => {
              hideFullLetter(); // G·ªçi h√†m ·∫©n th∆∞ ƒë√£ t·ªëi ∆∞u
              paperEl.style.transition = "transform 0.5s ease"; // D√πng l·∫°i transition m·∫∑c ƒë·ªãnh khi m·ªü
              paperEl.style.transform = "scale(1)"; // Reset v·ªã tr√≠ cho l·∫ßn m·ªü sau
            }, 300);
          } else {
            // Kh√¥ng ƒë·∫°t ng∆∞·ª°ng: ƒê∆∞a gi·∫•y v·ªÅ v·ªã tr√≠ c≈© (·ªü gi·ªØa)
            paperEl.style.transform = "scale(1)";
          }
        }
      });

      // --- Logic Nh·∫°c ---
      let isPlaying = false;

      function toggleMusic() {
        if (isPlaying) {
          music.pause();
          isPlaying = false;
          musicIcon.classList.remove("fa-volume-high", "note-anim");
          musicIcon.classList.add("fa-volume-xmark");
        } else {
          playMusic();
        }
      }

      function playMusic() {
        music
          .play()
          .then(() => {
            isPlaying = true;
            musicIcon.classList.remove("fa-volume-xmark");
            musicIcon.classList.add("fa-volume-high", "note-anim");
          })
          .catch((error) => {
            console.log(
              "Tr√¨nh duy·ªát ch·∫∑n auto-play, c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng tr∆∞·ªõc."
            );
          });
      }
    </script>
  </body>
</html>
